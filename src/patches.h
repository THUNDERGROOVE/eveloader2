//
// Created by Nick on 10/21/2021.
//

#ifndef EVELOADER2_PATCHES_H
#define EVELOADER2_PATCHES_H

#include "bluekey.h"

static char *original_sign_key_hex =
        "\x06\x02\x00\x00\x00\x24\x00\x00\x52\x53\x41\x31\x00\x04\x00\x00\x01\x00\x01\x00\x25\xa1\x20\x0c"
        "\xd9\x4c\xe9\x32\xca\x9b\x7c\x8b\x56\x32\xd2\x63\xb7\x41\x75\xc3\xc7\xf5\xd2\xcd\x07\x3a\xee\x91"
        "\x92\x12\x10\x0d\x1a\x0e\xc3\xab\x84\x61\x94\x2d\xc2\xd3\xcb\x0b\x92\xb3\x10\x87\x57\xd0\x44\xc8"
        "\x9f\x15\x77\x88\x33\x02\x9e\xbf\x25\x12\x32\xdf\x50\x93\x80\x41\x7c\x3c\xc4\x1d\xd5\x04\x83\xf3"
        "\x57\x1c\x15\x09\x0c\x04\xd4\xfd\xaa\xce\x12\xab\xb7\x7f\x74\xa6\x23\xd3\xe3\xa6\x6b\xaa\xfb\xbd"
        "\xb7\xde\xad\x0f\x77\xd7\x23\x92\x7e\x2a\x57\xc7\xb4\xb5\x67\xbd\x65\xeb\x51\x7a\x7f\x0c\x81\x41\xa5\x38\xf5\xa6";

static char *manifest_verify_func =
        "\x0F\x85\x1C\x01\x00\x00\xFF";
        // \xe9\x1d\x01\x00\x00


struct patch {
    char *name;
    char *original;
    char *updated;
    size_t size;
};

static patch patches[] = {
        // Nop out the JNE that does the error reporting
        {"CRC Checks(Blue Patcher)", "\x0F\x85\x8C\x02\x00\x00\xFF\x15\x7C\x82\x15\x10\x3D\x06", "\x90\xE9\x8C\x02\x00\x00\xFF\x15\x7C\x82\x15\x10\x3D\x06", 14},
        // Overwrite embedded key with our own
        //{"Code Signing", original_sign_key_hex, (char *)codeSigKey, 148},
        // Change JNE to JMP for verification ok
        {"VerifyManifestFile", "\x0F\x85\x1C\x01\x00\x00\xFF", "\xe9\x1d\x01\x00\x00\x00\x00", 7},
        // During initialization of the array of PyMethodDef for BluePyOS within blue.dll
        // esi is set to 0 and edi is set to 1 so we just swap out the register in the mov instruction
        // Currently non-functional.  Still doesn't allow modification to pyos.packaged :/
        // even found the copy in memory, flag is set correctly.
        //{"pyos.packaged R/O", "\x89\x3D\x24\x52", "\x89\x35\x24\x52", 4},
        //{"Packaged Client 2", "\x89\x3D\x30\x52", "\x89\x35\x30\x52", 4},
        // \x89\x3D\x24\x52\x37\x51
        {NULL, NULL, NULL, 0}
};

#endif //EVELOADER2_PATCHES_H
